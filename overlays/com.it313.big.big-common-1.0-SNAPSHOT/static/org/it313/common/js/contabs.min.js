$(function() {
	/**
	 * 重置左移右移显示状态，当标签页超过的时候显示，反之隐藏
	 */
	function fnResetArrow(){
		/*// 选项卡是否超出了可视宽度
		var isViewOver = ($(".contabs").outerWidth(true) - fnSumWidth($(".contabs").children().not(".J_menuTabs"))) <= fnSumWidth($(".contabs .J_menuTab")),
    	// 左移箭头是否可见
    	isLeftVisible = $('.J_tabLeft').is(':visible');
		
		if(!isLeftVisible && isViewOver){
        	$('.tab-btn-refresh').css('left', 40);
        	$('.J_menuTabs').css('margin-left', 80);
        	$('.J_tabLeft, .J_tabRight').show();
        }else if(isLeftVisible && !isViewOver){
        	$('.tab-btn-refresh').css('left', 0);
        	$('.J_menuTabs').css('margin-left', 40);
        	$('.J_tabLeft, .J_tabRight').hide();
        	$(".page-tabs-content").animate({marginLeft: 0 }, "fast");
        }*/
	}
	//$(window).resize(fnResetArrow);
	
	/**
	 * 计算宽度
	 */
    function fnSumWidth(doms) {
        var width = 0;
        $(doms).each(function() {
        	width += $(this).outerWidth(true);
        });
        return width;
    }
    
    /**
     * 定位激活的选项卡
     */
    function fnPositionTabActive(tab) {
    	fnResetArrow();
    	// tab标签之前的宽度
        var preAllWidth = fnSumWidth($(tab).prevAll()),
        	// tab标签之后的宽度
        	nextAllWidth = fnSumWidth($(tab).nextAll()),
        	// 除了菜单标签以后的宽度【左移，右移，刷新，关闭操作...】
        	otherWidth = fnSumWidth($(".content-header .contabs").children().not(".J_menuTabs")),
        	// 导航栏菜单标签可视宽度
        	tabViewWidth = $(".content-header").outerWidth(true) - otherWidth;
        
        var animateWidth = 0;
        if ($(".page-tabs-content").outerWidth() < tabViewWidth) {
            animateWidth = 0;
        } else {
            if (nextAllWidth <= tabViewWidth - $(tab).outerWidth(true) - $(tab).next().outerWidth(true)) {
                if (tabViewWidth - $(tab).next().outerWidth(true) > nextAllWidth) {
                	animateWidth = preAllWidth;
                    var m = tab;
                    while (animateWidth - $(m).outerWidth() > $(".page-tabs-content").outerWidth() - tabViewWidth) {
                    	animateWidth -= $(m).prev().outerWidth();
                        m = $(m).prev();
                    }
                }
            } else {
                if (preAllWidth > tabViewWidth - $(tab).outerWidth(true) - $(tab).prev().outerWidth(true)) {
                	animateWidth = preAllWidth - $(tab).prev().outerWidth(true);
                }
            }
        }
        $(".page-tabs-content").animate({
            marginLeft: 0 - animateWidth + "px"
        }, "fast");
    }
    
    /**
     * 选项卡左移方法
     */
    function fnTabLeft() {
        var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
        var l = fnSumWidth($(".content-header .contabs").children().not(".J_menuTabs"));
        var k = $(".content-header").outerWidth(true) - l;
        var p = 0;
        if ($(".page-tabs-content").width() < k) {
            return false;
        } else {
            var m = $(".J_menuTab:first");
            var n = 0;
            while (n + $(m).outerWidth(true) <= o) {
                n += $(m).outerWidth(true);
                m = $(m).next();
            }
            n = 0;
            if (fnSumWidth($(m).prevAll()) > k) {
                while (n + $(m).outerWidth(true) < k && m.length > 0) {
                    n += $(m).outerWidth(true);
                    m = $(m).prev();
                }
                p = fnSumWidth($(m).prevAll());
            }
        }
        $(".page-tabs-content").animate({
            marginLeft: 0 - p + "px"
        }, "fast");
    }
    
    /**
     * 选项卡右移方法
     */
    function fnTabRight() {
        var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
        var l = fnSumWidth($(".content-header .contabs").children().not(".J_menuTabs"));
        var k = $(".content-header").outerWidth(true) - l;
        var p = 0;
        if ($(".page-tabs-content").width() < k) {
            return false;
        } else {
            var m = $(".J_menuTab:first");
            var n = 0;
            while (n + $(m).outerWidth(true) <= o) {
                n += $(m).outerWidth(true);
                m = $(m).next();
            }
            n = 0;
            while (n + $(m).outerWidth(true) < k && m.length > 0) {
                n += $(m).outerWidth(true);
                m = $(m).next();
            }
            p = fnSumWidth($(m).prevAll());
            if (p > 0) {
                $(".page-tabs-content").animate({
                    marginLeft: 0 - p + "px"
                }, "fast");
            }
        }
    }
    
    $(".J_menuItem").each(function(k) {
        if (!$(this).attr("data-index")) {
            $(this).attr("data-index", k);
        }
    });
    
    /**
     * 菜单点击方法
     */
    function fnMenuClick() {
        var href = $(this).attr("data-href"),treeid = $(this).attr("data-treeid"),location = $(this).parent().attr("location"), index = $(this).data("index"), title = $.trim($(this).find('.fs').length>0?$(this).find('.fs').text():$(this).text()), addTab = true;
        if (href == undefined || $.trim(href).length == 0) {
            return false;
        }
        $(".J_menuTab").each(function() {
            if ($(this).data("id") == href) {
                if (!$(this).hasClass("active")) {
                    $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
                    fnPositionTabActive(this);
                    $(".J_mainContent .J_iframe").each(function() {
                        if ($(this).data("id") == href) {
                            $(this).show().siblings(".J_iframe").hide();
                            return false;
                        }
                    });
                }
                addTab = false;
                return false;
            }
        });
        if (addTab) {
            var menuTabHtml = '<a href="javascript:;" class="active J_menuTab" data-id="' + href + '">' + title + ' <i class="fa fa-times-circle"></i></a>';
            $(".J_menuTab").removeClass("active");
            var $iframe = $('<iframe class="J_iframe" name="iframe' + index + '" width="100%" height="100%" src="' + href + (href.indexOf('?')!=-1? '&isIframe=true':'?isIframe=true') + '" frameborder="0" data-id="' + href + '" data-treeid="' + treeid + '" data-location="' + location + '" seamless></iframe>');
            $(".J_mainContent").find("iframe.J_iframe").hide();
            $(".J_mainContent").append($iframe);
            $iframe.load(function(){
            	$iframe.contents().click(function () {
            		$('.sidebar-right').animate({opacity: 0, right: -280},'fast');
                	$('#Tab-Menu-Ul').hide();
                	$('#dropdown_menu').hide();
                });
            })
            $(".J_menuTabs .page-tabs-content").append(menuTabHtml);
            fnPositionTabActive($(".J_menuTab.active"));
        }
        return false;
    }
    
    /**
     * 关闭选项卡方法
     */
    function fnMenuTabCloseClick() {
        var m = $(this).parents(".J_menuTab").data("id");
        var l = $(this).parents(".J_menuTab").width();
        if ($(this).parents(".J_menuTab").hasClass("active")) {
        	fnResetArrow();
            if ($(this).parents(".J_menuTab").next(".J_menuTab").size()) {
                var k = $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").data("id");
                $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").addClass("active");
                $(".J_mainContent .J_iframe").each(function() {
                    if ($(this).data("id") == k) {
                        $(this).show().siblings(".J_iframe").hide();
                        return false;
                    }
                });
                var n = parseInt($(".page-tabs-content").css("margin-left"));
                if (n < 0) {
                    $(".page-tabs-content").animate({
                        marginLeft: n + l + "px"
                    }, "fast");
                }
                $(this).parents(".J_menuTab").remove();
                $(".J_mainContent .J_iframe").each(function() {
                    if ($(this).data("id") == m) {
                        $(this).remove();
                        return false;
                    }
                });
            }
            if ($(this).parents(".J_menuTab").prev(".J_menuTab").size()) {
                var k = $(this).parents(".J_menuTab").prev(".J_menuTab:last").data("id");
                $(this).parents(".J_menuTab").prev(".J_menuTab:last").addClass("active");
                $(".J_mainContent .J_iframe").each(function() {
                    if ($(this).data("id") == k) {
                        $(this).show().siblings(".J_iframe").hide();
                        return false;
                    }
                });
                $(this).parents(".J_menuTab").remove();
                $(".J_mainContent .J_iframe").each(function() {
                    if ($(this).data("id") == m) {
                        $(this).remove();
                        return false;
                    }
                });
            }
        } else {
            $(this).parents(".J_menuTab").remove();
            $(".J_mainContent .J_iframe").each(function() {
                if ($(this).data("id") == m) {
                    $(this).remove();
                    return false;
                }
            });
            fnPositionTabActive($(".J_menuTab.active"));
        }
        return false;
    }
    $(".J_menuTabs").on("click", ".J_menuTab i", fnMenuTabCloseClick);
    
    /**
     * 关闭其他选显卡
     */
    function fnTabCloseOther() {
        $(".page-tabs-content").children("[data-id]").not(":first").not(".active").each(function() {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
            $(this).remove();
        });
        $(".page-tabs-content").css("margin-left", "0");
    }
    
    /**
     * 定位当前选项卡
     */
    function fnTabShowActive() {
    	fnPositionTabActive($(".J_menuTab.active"));
    }
    
    /**
     * 选项卡选中方法
     */
    function fnTabActive() {
        if (!$(this).hasClass("active")) {
            var k = $(this).data("id");
            $(".J_mainContent .J_iframe").each(function() {
                if ($(this).data("id") == k) {
                    $(this).show().siblings(".J_iframe").hide();
                    return false;
                }
            });
            $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
            fnPositionTabActive(this);
        }
    }
    
    /**
     * 选项卡双击
     */
    function fnTabDblclick() {
        var l = $('.J_iframe[data-id="' + $(this).data("id") + '"]');
        var k = l.attr("src");
    }
    
    /**
     * 多选项卡模式事件绑定
     */
    if(!turboMode){
	    //菜单注册点击事件
	    $(document).on("click", ".J_menuItem", fnMenuClick);
	    $(".J_tabCloseOther").on("click", fnTabCloseOther);
	    $(".J_tabShowActive").on("click", fnTabShowActive);
	    $(".J_menuTabs").on("click", ".J_menuTab", fnTabActive);
	    $(".J_menuTabs").on("dblclick", ".J_menuTab", fnTabDblclick);
	    $(".J_tabLeft").on("click", fnTabLeft);
	    $(".J_tabRight").on("click", fnTabRight);
	    
	    // 关闭所有
	    $(".J_tabCloseAll").on("click", function() {
	        $(".page-tabs-content").children("[data-id]").not(":first").each(function() {
	            $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
	            $(this).remove();
	        });
	        $(".page-tabs-content").children("[data-id]:first").each(function() {
	            $('.J_iframe[data-id="' + $(this).data("id") + '"]').show();
	            $(this).addClass("active");
	        });
	        $(".page-tabs-content").css("margin-left", "0");
	    });
	    
	    //刷新当前选项卡
	    $('.tab-btn-refresh').click(function(){
	    	var J_current_iframe = $('.J_mainContent .J_iframe:visible');
	    	J_current_iframe.attr('src', J_current_iframe.attr('src'));
	    });
    }
});